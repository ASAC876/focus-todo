<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FOCUS">
<meta name="theme-color" content="#0f0f0f">
<title>FOCUS â€” ã‚¿ã‚¹ã‚¯ç®¡ç†</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f0f;
    --surface: #1a1a1a;
    --border: #2a2a2a;
    --accent: #e8ff47;
    --accent2: #ff6b35;
    --text: #f0f0f0;
    --muted: #666;
    --urgent: #ff4757;
    --high: #ff6b35;
    --medium: #e8ff47;
    --low: #4ecdc4;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans JP', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* HEADER */
  header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    background: var(--bg);
    z-index: 100;
  }
  .logo {
    font-family: 'Syne', sans-serif;
    font-size: 22px;
    font-weight: 800;
    letter-spacing: 4px;
    color: var(--accent);
  }
  .date-display {
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--muted);
  }

  /* URGENT BANNER */
  #urgent-banner {
    background: linear-gradient(135deg, #1a0a0a, #200d0d);
    border-bottom: 2px solid var(--urgent);
    padding: 0;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  #urgent-banner.empty { display: none; }
  .banner-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 24px 8px;
  }
  .banner-label {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 3px;
    color: var(--urgent);
    text-transform: uppercase;
  }
  .pulse {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--urgent);
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }
  .urgent-tasks {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 0 24px 12px;
  }
  .urgent-chip {
    display: flex;
    align-items: center;
    gap: 6px;
    background: rgba(255,71,87,0.12);
    border: 1px solid rgba(255,71,87,0.3);
    border-radius: 4px;
    padding: 5px 10px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .urgent-chip:hover { background: rgba(255,71,87,0.2); }
  .urgent-chip.overdue { border-color: var(--urgent); }
  .urgent-chip .chip-date {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--urgent);
  }
  .urgent-chip.done-chip { opacity: 0.4; text-decoration: line-through; }

  /* MAIN */
  main { padding: 20px 24px; max-width: 680px; margin: 0 auto; }

  /* ADD TASK */
  .add-section {
    margin-bottom: 28px;
  }
  .add-section h2 {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 3px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 12px;
  }
  .add-form {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .add-form input[type="text"] {
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 15px;
    padding: 6px 0;
    outline: none;
    width: 100%;
    transition: border-color 0.2s;
  }
  .add-form input[type="text"]:focus { border-color: var(--accent); }
  .add-form input[type="text"]::placeholder { color: var(--muted); }
  .form-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  .form-row label {
    font-size: 12px;
    color: var(--muted);
    white-space: nowrap;
  }
  .priority-select, .date-input {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    padding: 5px 8px;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .priority-select:focus, .date-input:focus { border-color: var(--accent); }
  .date-input { color-scheme: dark; }
  .add-btn {
    margin-left: auto;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 1px;
    padding: 7px 18px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .add-btn:hover { background: #fff; transform: translateY(-1px); }

  /* TASK LIST */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    margin-top: 8px;
  }
  .section-title {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 3px;
    color: var(--muted);
    text-transform: uppercase;
  }
  .task-count {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--muted);
  }

  .filter-bar {
    display: flex;
    gap: 6px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .filter-btn {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 1px;
    padding: 4px 10px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .filter-btn.active, .filter-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  #task-list { display: flex; flex-direction: column; gap: 8px; }

  .task-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid transparent;
    border-radius: 6px;
    padding: 12px 14px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    transition: all 0.2s;
    animation: slideIn 0.2s ease;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .task-item:hover { border-color: #333; }
  .task-item.p-urgent { border-left-color: var(--urgent); }
  .task-item.p-high { border-left-color: var(--high); }
  .task-item.p-medium { border-left-color: var(--medium); }
  .task-item.p-low { border-left-color: var(--low); }
  .task-item.done {
    opacity: 0.4;
  }
  .task-item.done .task-title { text-decoration: line-through; }

  .task-check {
    width: 18px;
    height: 18px;
    border: 2px solid var(--border);
    border-radius: 4px;
    flex-shrink: 0;
    margin-top: 2px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }
  .task-check:hover { border-color: var(--accent); }
  .task-check.checked {
    background: var(--accent);
    border-color: var(--accent);
  }
  .task-check.checked::after {
    content: 'âœ“';
    color: #000;
    font-size: 11px;
    font-weight: 700;
  }

  .task-body { flex: 1; min-width: 0; }
  .task-title { font-size: 14px; line-height: 1.4; word-break: break-word; }
  .task-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 5px;
    flex-wrap: wrap;
  }
  .task-priority {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    padding: 2px 6px;
    border-radius: 3px;
  }
  .task-priority.p-urgent { background: rgba(255,71,87,0.15); color: var(--urgent); }
  .task-priority.p-high { background: rgba(255,107,53,0.15); color: var(--high); }
  .task-priority.p-medium { background: rgba(232,255,71,0.12); color: var(--medium); }
  .task-priority.p-low { background: rgba(78,205,196,0.12); color: var(--low); }

  .task-date {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--muted);
  }
  .task-date.overdue { color: var(--urgent); }
  .task-date.today { color: var(--high); }
  .task-date.soon { color: var(--medium); }

  .task-delete {
    background: transparent;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 16px;
    padding: 0 2px;
    line-height: 1;
    transition: color 0.15s;
    flex-shrink: 0;
  }
  .task-delete:hover { color: var(--urgent); }

  .empty-state {
    text-align: center;
    padding: 48px 0;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    letter-spacing: 1px;
  }
  .empty-state .big { font-size: 32px; margin-bottom: 12px; opacity: 0.3; }

  /* COMPLETED SECTION */
  .completed-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    margin-top: 24px;
    padding: 8px 0;
    border-top: 1px solid var(--border);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    user-select: none;
  }
  .completed-toggle:hover { color: var(--text); }
  .toggle-icon { transition: transform 0.2s; }
  .toggle-icon.open { transform: rotate(90deg); }
  #completed-list { display: none; flex-direction: column; gap: 6px; margin-top: 10px; }
  #completed-list.visible { display: flex; }

  @media (max-width: 480px) {
    header { padding: 14px 16px; }
    main { padding: 16px; }
    .urgent-tasks { padding: 0 16px 10px; }
    .banner-header { padding: 10px 16px 6px; }
  }
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:24px;">
  <div style="font-family:'Syne',sans-serif;font-size:28px;font-weight:800;letter-spacing:4px;color:#e8ff47;margin-bottom:8px;">FOCUS</div>
  <div style="font-family:'DM Mono',monospace;font-size:11px;color:#666;letter-spacing:2px;margin-bottom:40px;">ã‚¿ã‚¹ã‚¯ç®¡ç†</div>
  <div style="background:#1a1a1a;border:1px solid #2a2a2a;border-radius:8px;padding:28px;width:100%;max-width:360px;display:flex;flex-direction:column;gap:16px;">
    <input id="auth-email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="background:#0f0f0f;border:1px solid #2a2a2a;border-radius:4px;color:#f0f0f0;font-family:'Noto Sans JP',sans-serif;font-size:14px;padding:10px 12px;outline:none;width:100%;box-sizing:border-box;">
    <input id="auth-password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="background:#0f0f0f;border:1px solid #2a2a2a;border-radius:4px;color:#f0f0f0;font-family:'Noto Sans JP',sans-serif;font-size:14px;padding:10px 12px;outline:none;width:100%;box-sizing:border-box;">
    <button onclick="signIn(document.getElementById('auth-email').value, document.getElementById('auth-password').value)" style="background:#e8ff47;border:none;border-radius:4px;color:#000;font-family:'DM Mono',monospace;font-size:13px;font-weight:500;padding:10px;cursor:pointer;transition:all 0.15s;">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button onclick="signUp(document.getElementById('auth-email').value, document.getElementById('auth-password').value)" style="background:transparent;border:1px solid #2a2a2a;border-radius:4px;color:#666;font-family:'DM Mono',monospace;font-size:13px;padding:10px;cursor:pointer;transition:all 0.15s;">æ–°è¦ç™»éŒ²</button>
  </div>
  <div style="margin-top:24px;background:#1a1a1a;border:1px solid #2a2a2a;border-radius:8px;padding:20px;width:100%;max-width:360px;box-sizing:border-box;">
    <div style="font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;color:#666;margin-bottom:14px;">ä½¿ã„æ–¹</div>
    <div style="font-family:'Noto Sans JP',sans-serif;font-size:13px;color:#888;line-height:1.9;">
      <div style="color:#e8ff47;font-size:11px;font-family:'DM Mono',monospace;letter-spacing:1px;margin-bottom:6px;">åˆå›ç™»éŒ²</div>
      1. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›<br>
      2. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆ8æ–‡å­—ä»¥ä¸Šæ¨å¥¨ï¼‰<br>
      3. ã€Œæ–°è¦ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™<br>
      4. ãã®ã¾ã¾ã‚¢ãƒ—ãƒªãŒé–‹ãã¾ã™<br>
      <div style="color:#e8ff47;font-size:11px;font-family:'DM Mono',monospace;letter-spacing:1px;margin-top:12px;margin-bottom:6px;">2å›ç›®ä»¥é™</div>
      1. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›<br>
      2. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›<br>
      3. ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™<br>
      <div style="color:#e8ff47;font-size:11px;font-family:'DM Mono',monospace;letter-spacing:1px;margin-top:12px;margin-bottom:6px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆ</div>
      ç¾åœ¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ç™»éŒ²ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ·»ãˆã¦<br>ç®¡ç†è€…ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚<br><a href='mailto:focus@yah00.co.jp' style='color:#e8ff47;'>focus@yah00.co.jp</a>
    </div>
  </div>
</div>

<!-- APP SCREEN -->
<div id="app-screen" style="display:none;">

<header>
  <div class="logo">FOCUS</div>
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="date-display" id="date-display"></div>
    <span id="user-email" style="font-family:'DM Mono',monospace;font-size:11px;color:#444;"></span>
    <button onclick="signOut()" style="background:transparent;border:1px solid #2a2a2a;border-radius:4px;color:#666;font-family:'DM Mono',monospace;font-size:11px;padding:4px 10px;cursor:pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</header>

<!-- URGENT BANNER -->
<div id="urgent-banner">
  <div class="banner-header">
    <div class="pulse"></div>
    <div class="banner-label">è¦å¯¾å¿œ â€” ä»Šæ—¥ãƒ»è¿‘æ—¥ä¸­</div>
  </div>
  <div class="urgent-tasks" id="urgent-chips"></div>
</div>

<main>
  <!-- ADD TASK -->
  <div class="add-section">
    <h2>+ ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h2>
    <div class="add-form">
      <input type="text" id="task-input" placeholder="ä½•ã‚’ã‚„ã‚Šã¾ã™ã‹ï¼Ÿ" maxlength="100">
      <div class="form-row">
        <label>å„ªå…ˆåº¦</label>
        <select class="priority-select" id="priority-select">
          <option value="urgent">ğŸ”´ ç·Šæ€¥</option>
          <option value="high">ğŸŸ  é«˜</option>
          <option value="medium" selected>ğŸŸ¡ ä¸­</option>
          <option value="low">ğŸ”µ ä½</option>
        </select>
        <label>æœŸé™</label>
        <input type="date" class="date-input" id="date-input">
        <button class="add-btn" onclick="addTask()">è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- FILTER -->
  <div class="section-header">
    <div class="section-title">ã‚¿ã‚¹ã‚¯ä¸€è¦§</div>
    <div class="task-count" id="task-count"></div>
  </div>
  <div class="filter-bar">
    <button class="filter-btn active" data-filter="all" onclick="setFilter('all',this)">ã™ã¹ã¦</button>
    <button class="filter-btn" data-filter="urgent" onclick="setFilter('urgent',this)">ğŸ”´ ç·Šæ€¥</button>
    <button class="filter-btn" data-filter="high" onclick="setFilter('high',this)">ğŸŸ  é«˜</button>
    <button class="filter-btn" data-filter="medium" onclick="setFilter('medium',this)">ğŸŸ¡ ä¸­</button>
    <button class="filter-btn" data-filter="low" onclick="setFilter('low',this)">ğŸ”µ ä½</button>
  </div>

  <div id="task-list"></div>

  <!-- COMPLETED -->
  <div class="completed-toggle" onclick="toggleCompleted()">
    <span class="toggle-icon" id="toggle-icon">â–¶</span>
    <span>å®Œäº†æ¸ˆã¿ (<span id="completed-count">0</span>)</span>
  </div>
  <div id="completed-list"></div>
</main>

<script>
  const SUPABASE_URL = 'https://pgfvmtufnplckypyazqp.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnZnZtdHVmbnBsY2t5cHlhenFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3NzMyMDYsImV4cCI6MjA4NzM0OTIwNn0.Hvbz6SXp__9ggTXVXYqPDe9vhlBa0St7LoNdP9pkmcg';

  let accessToken = SUPABASE_KEY;
  let currentUser = null;

  function getHeaders() {
    return {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + accessToken,
      'Content-Type': 'application/json',
      'Prefer': 'return=representation'
    };
  }

  let tasks = [];
  let currentFilter = 'all';

  const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
  const priorityLabel = { urgent: 'ç·Šæ€¥', high: 'é«˜', medium: 'ä¸­', low: 'ä½' };

  async function loadTasks() {
    if (!currentUser) return;
    const res = await fetch(SUPABASE_URL + '/rest/v1/tasks?order=id.asc', { headers: getHeaders() });
    tasks = await res.json();
    render();
  }

  async function save() {
    // no-op: each operation calls Supabase directly
  }

  function today() {
    return new Date().toISOString().slice(0, 10);
  }

  function soonDate() {
    const d = new Date();
    d.setDate(d.getDate() + 3);
    return d.toISOString().slice(0, 10);
  }

  function dateStatus(dateStr) {
    if (!dateStr) return null;
    const t = today();
    if (dateStr < t) return 'overdue';
    if (dateStr === t) return 'today';
    if (dateStr <= soonDate()) return 'soon';
    return 'future';
  }

  function formatDate(dateStr) {
    if (!dateStr) return '';
    const status = dateStatus(dateStr);
    const d = new Date(dateStr + 'T00:00:00');
    const mm = d.getMonth() + 1;
    const dd = d.getDate();
    const label = `${mm}/${dd}`;
    if (status === 'overdue') return `âš  ${label} æœŸé™åˆ‡ã‚Œ`;
    if (status === 'today') return `ğŸ”¥ ä»Šæ—¥ã¾ã§`;
    if (status === 'soon') return `â° ${label}`;
    return label;
  }

  async function addTask() {
    const input = document.getElementById('task-input');
    const title = input.value.trim();
    if (!title) { input.focus(); return; }
    const priority = document.getElementById('priority-select').value;
    const date = document.getElementById('date-input').value;
    const res = await fetch(SUPABASE_URL + '/rest/v1/tasks', {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify({ title, priority, date, done: false, created: today(), user_id: currentUser.id })
    });
    const rows = await res.json();
    tasks.push(rows[0]);
    input.value = '';
    document.getElementById('date-input').value = '';
    render();
    input.focus();
  }



  async function toggleDone(id) {
    const t = tasks.find(t => t.id === id);
    if (!t) return;
    t.done = !t.done;
    await fetch(SUPABASE_URL + '/rest/v1/tasks?id=eq.' + id, {
      method: 'PATCH',
      headers: getHeaders(),
      body: JSON.stringify({ done: t.done })
    });
    render();
  }

  async function deleteTask(id) {
    tasks = tasks.filter(t => t.id !== id);
    await fetch(SUPABASE_URL + '/rest/v1/tasks?id=eq.' + id, {
      method: 'DELETE',
      headers: getHeaders()
    });
    render();
  }

  function setFilter(f, btn) {
    currentFilter = f;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    render();
  }

  function toggleCompleted() {
    const list = document.getElementById('completed-list');
    const icon = document.getElementById('toggle-icon');
    list.classList.toggle('visible');
    icon.classList.toggle('open');
  }

  function isUrgent(task) {
    if (task.done) return false;
    if (task.priority === 'urgent') return true;
    if (!task.date) return false;
    const s = dateStatus(task.date);
    return s === 'overdue' || s === 'today' || s === 'soon';
  }

  function render() {
    // Date display
    const now = new Date();
    const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    document.getElementById('date-display').textContent =
      `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')} (${days[now.getDay()]})`;

    // Urgent banner
    const urgentTasks = tasks.filter(isUrgent);
    const banner = document.getElementById('urgent-banner');
    const chips = document.getElementById('urgent-chips');
    if (urgentTasks.length === 0) {
      banner.classList.add('empty');
    } else {
      banner.classList.remove('empty');
      chips.innerHTML = urgentTasks.map(t => {
        const s = t.date ? dateStatus(t.date) : null;
        return `<div class="urgent-chip ${s === 'overdue' ? 'overdue' : ''}" onclick="toggleDone(${t.id})">
          <span>${t.title}</span>
          ${t.date ? `<span class="chip-date">${formatDate(t.date)}</span>` : ''}
        </div>`;
      }).join('');
    }

    // Active tasks
    let active = tasks.filter(t => !t.done);
    if (currentFilter !== 'all') active = active.filter(t => t.priority === currentFilter);

    // Sort: priority â†’ date
    active.sort((a, b) => {
      const pd = priorityOrder[a.priority] - priorityOrder[b.priority];
      if (pd !== 0) return pd;
      if (!a.date && !b.date) return 0;
      if (!a.date) return 1;
      if (!b.date) return -1;
      return a.date.localeCompare(b.date);
    });

    document.getElementById('task-count').textContent = `${active.length} ä»¶`;

    const list = document.getElementById('task-list');
    if (active.length === 0) {
      list.innerHTML = `<div class="empty-state"><div class="big">âœ“</div>${currentFilter === 'all' ? 'ã‚¿ã‚¹ã‚¯ãªã—ã€‚ã„ã„æ„Ÿã˜ï¼' : 'ã“ã®ã‚«ãƒ†ã‚´ãƒªã¯ç©ºã§ã™'}</div>`;
    } else {
      list.innerHTML = active.map(t => taskHTML(t)).join('');
    }

    // Completed
    const done = tasks.filter(t => t.done);
    document.getElementById('completed-count').textContent = done.length;
    const doneList = document.getElementById('completed-list');
    doneList.innerHTML = done.map(t => taskHTML(t)).join('');
  }

  async function cyclePriority(id) {
    const t = tasks.find(t => t.id === id);
    if (!t) return;
    const order = ['urgent', 'high', 'medium', 'low'];
    const idx = order.indexOf(t.priority);
    t.priority = order[(idx + 1) % order.length];
    await fetch(SUPABASE_URL + '/rest/v1/tasks?id=eq.' + id, {
      method: 'PATCH',
      headers: getHeaders(),
      body: JSON.stringify({ priority: t.priority })
    });
    render();
  }

  async function setDate(id, val) {
    const t = tasks.find(t => t.id === id);
    if (!t) return;
    t.date = val || '';
    await fetch(SUPABASE_URL + '/rest/v1/tasks?id=eq.' + id, {
      method: 'PATCH',
      headers: getHeaders(),
      body: JSON.stringify({ date: t.date })
    });
    render();
  }

  function openDatePicker(id) {
    const el = document.getElementById('date-picker-' + id);
    if (!el) return;
    el.style.display = 'block';
    el.style.opacity = '1';
    el.style.pointerEvents = 'auto';
    el.focus();
    el.click();
    el.addEventListener('blur', () => { el.style.display = 'none'; }, { once: true });
  }

  function taskHTML(t) {
    const s = t.date ? dateStatus(t.date) : null;
    const dateClass = s === 'overdue' ? 'overdue' : s === 'today' ? 'today' : s === 'soon' ? 'soon' : '';
    const dateSpan = t.date
      ? '<span class="task-date ' + dateClass + '" onclick="openDatePicker(' + t.id + ')" title="ã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´" style="cursor:pointer;">' + formatDate(t.date) + '</span>'
      : '<span class="task-date" onclick="openDatePicker(' + t.id + ')" title="æœŸé™ã‚’è¨­å®š" style="cursor:pointer;color:var(--muted);">ï¼‹ æœŸé™</span>';
    const html = '<div class="task-item p-' + t.priority + ' ' + (t.done ? 'done' : '') + '" style="position:relative;">'
      + '<div class="task-check ' + (t.done ? 'checked' : '') + '" onclick="toggleDone(' + t.id + ')"></div>'
      + '<div class="task-body">'
      + '<div class="task-title">' + escapeHtml(t.title) + '</div>'
      + '<div class="task-meta">'
      + '<span class="task-priority p-' + t.priority + '" onclick="cyclePriority(' + t.id + ')" title="ã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´" style="cursor:pointer;user-select:none;">' + priorityLabel[t.priority] + ' â†»</span>'
      + dateSpan
      + '<input type="date" id="date-picker-' + t.id + '" value="' + (t.date || '') + '" style="position:absolute;opacity:0;pointer-events:none;width:1px;height:1px;" onchange="setDate(' + t.id + ', this.value)">'
      + '</div>'
      + '</div>'
      + '<button class="task-delete" onclick="deleteTask(' + t.id + ')">Ã—</button>'
      + '</div>';
    return html;
  }

  function escapeHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // Supabase Realtime
  let realtimeRef = 0;

  function setupRealtime() {
    console.log('setupRealtime called, user:', currentUser ? currentUser.email : 'none');
    const wsUrl = 'wss://pgfvmtufnplckypyazqp.supabase.co/realtime/v1/websocket?apikey=' + SUPABASE_KEY + '&vsn=1.0.0';
    const ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      console.log('WebSocket connected');
      realtimeRef++;
      ws.send(JSON.stringify({
        topic: 'realtime:public:tasks',
        event: 'phx_join',
        payload: {
          config: {
            postgres_changes: [{ event: '*', schema: 'public', table: 'tasks' }]
          }
        },
        ref: String(realtimeRef)
      }));
    };

    ws.onmessage = (e) => {
      const msg = JSON.parse(e.data);
      console.log('WS message:', msg.event);
      if (msg.event === 'postgres_changes') {
        console.log('DB change detected, reloading tasks');
        loadTasks();
      }
    };

    ws.onclose = () => {
      console.log('WebSocket closed, reconnecting...');
      setTimeout(setupRealtime, 3000);
    };

    ws.onerror = (e) => {
      console.error('WebSocket error:', e);
    };

    setInterval(() => {
      if (ws.readyState === WebSocket.OPEN) {
        realtimeRef++;
        ws.send(JSON.stringify({ topic: 'phoenix', event: 'heartbeat', payload: {}, ref: String(realtimeRef) }));
      }
    }, 20000);
  }

  // Auth
  async function signUp(email, password) {
    const res = await fetch(SUPABASE_URL + '/auth/v1/signup', {
      method: 'POST',
      headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if (data.access_token) {
      accessToken = data.access_token;
      currentUser = data.user;
      localStorage.setItem('focus-token', accessToken);
      localStorage.setItem('focus-refresh', data.refresh_token || '');
      localStorage.setItem('focus-user', JSON.stringify(currentUser));
      showApp();
      loadTasks();
      setupRealtime();
    } else {
      alert('ã‚¨ãƒ©ãƒ¼: ' + (data.message || data.msg || data.error_description || JSON.stringify(data)));
    }
  }

  async function signIn(email, password) {
    const res = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=password', {
      method: 'POST',
      headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if (data.access_token) {
      accessToken = data.access_token;
      currentUser = data.user;
      localStorage.setItem('focus-token', accessToken);
      localStorage.setItem('focus-refresh', data.refresh_token || '');
      localStorage.setItem('focus-user', JSON.stringify(currentUser));
      showApp();
      loadTasks();
      setupRealtime();
    } else {
      alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
    }
  }

  async function refreshToken() {
    const refreshTk = localStorage.getItem('focus-refresh');
    if (!refreshTk) { signOut(); return; }
    const res = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
      method: 'POST',
      headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
      body: JSON.stringify({ refresh_token: refreshTk })
    });
    const data = await res.json();
    if (data.access_token) {
      accessToken = data.access_token;
      localStorage.setItem('focus-token', accessToken);
      localStorage.setItem('focus-refresh', data.refresh_token || refreshTk);
      console.log('Token refreshed');
    } else {
      console.log('Token refresh failed, signing out');
      signOut();
    }
  }

  function signOut() {
    accessToken = SUPABASE_KEY;
    currentUser = null;
    localStorage.removeItem('focus-token');
    localStorage.removeItem('focus-refresh');
    localStorage.removeItem('focus-user');
    showAuth();
  }

  function showApp() {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('app-screen').style.display = 'block';
    document.getElementById('user-email').textContent = currentUser.email;
  }

  function showAuth() {
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('app-screen').style.display = 'none';
  }

  // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
  const savedToken = localStorage.getItem('focus-token');
  const savedUser = localStorage.getItem('focus-user');
  if (savedToken && savedUser) {
    accessToken = savedToken;
    currentUser = JSON.parse(savedUser);
    showApp();
    refreshToken().then(() => { loadTasks(); setupRealtime(); });
    // 50åˆ†ã”ã¨ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•æ›´æ–°
    setInterval(refreshToken, 50 * 60 * 1000);
  } else {
    showAuth();
  }
</script>
</div><!-- /app-screen -->

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }
</script>
</body>
</html>
